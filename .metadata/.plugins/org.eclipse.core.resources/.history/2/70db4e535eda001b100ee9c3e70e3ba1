package com.joker.control;

import java.io.IOException;
import java.sql.SQLException;

import javax.servlet.RequestDispatcher;
import javax.servlet.ServletException;
import javax.servlet.ServletRequest;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

import com.joker.modelo.Usuario;
import com.joker.modelo.UsuarioDAO;
import com.joker.modelo.Pregunta;
import com.joker.modelo.PreguntaDAO;

@WebServlet("/Login")
public class Login extends HttpServlet {

	protected void doPost(HttpServletRequest request, HttpServletResponse response)
			throws ServletException, IOException {

		String email = request.getParameter("email");
		String pass = request.getParameter("password");

		UsuarioDAO udao = new UsuarioDAO();
		Usuario usu = null;
		String pageDest = "login.jsp";

		try {
			usu = udao.login(email, pass);
			
			
			// usuario existe en la BDD
		
			
			if (usu != null) {
				
				
				ServletRequest sesion = (ServletRequest) request.getSession();;
				if (usu != null &&sesion.getAttribute("rol").equals("admin")) {
					
					
					pageDest = "admin.jsp";
					HttpSession sesion1 = request.getSession();
					sesion1.setAttribute("nombre", usu.getNombre());
					sesion1.setAttribute("apellido", usu.getApellidos());
					sesion1.setAttribute("edad", usu.getEdad());
					sesion1.setAttribute("email", usu.getEmail());
					sesion1.setAttribute("rol", usu.getRol());
					
					
				}else {
					
					pageDest = "usuarios.jsp";
					HttpSession sesion1 = request.getSession();
					sesion1.setAttribute("nombre", usu.getNombre());
					sesion1.setAttribute("apellido", usu.getApellidos());
					sesion1.setAttribute("edad", usu.getEdad());
					sesion1.setAttribute("email", usu.getEmail());
					sesion1.setAttribute("rol", usu.getRol());
					
				
				
				
				
				
			}
			}

				else {
					String msgerr = "usuario y constraseña incorrecta";
					request.setAttribute("msgerr", msgerr);

					// empleado no existe en la bdd
				}
			
			
		
		}catch (SQLException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}

		

		RequestDispatcher rd = request.getRequestDispatcher(pageDest);
		rd.forward(request, response);
	

}
}
